\chapter{Разработка моделей и алгоритмов}

% В этой главе описываются разработанные/модифицированные модели/методы/
% алгоритмы, или/и описывается применение известных стандартных методов. Также,
% в конце главы обычно приводится общая архитектура программной системы,
% вытекающая из описанной теории. Приведенные ниже заголовки подразделов так же
% весьма примерные и сильно зависят от особенностей конкретной работы.


\begin{annotation}
	В данной главе описываются алгоритмы работы нечетких когнитивных карт.
	Описывается модифицированная модель когнитивных карт с использованием
	рекуррентных нейросетей и сетей прямого распространения.
	Производится выбор метрик оценки качества работы системы.
\end{annotation}

\section{Описание алгоритма работы нечетких когнитивных карт}

Когнитивная карта – схема причинно-следственных связей в системе.
Когнитивная карта представляет из себя ориентированный граф.
Вершины этого графа – концепты, а ребра – причинно-следственные связи между соответствующими концептами.
Когнитивные карты строятся для того, чтобы понять и проанализировать структуру сложной системы.
Каждое ребро когнитивной карты имеет свой вес, который характеризует степень влияния одного концепта на другой.

Обычно при прогнозировании с использованием нечетких когнитивных карт существует один целевой концепт,
значение которого необходимо спрогнозировать.


Стандартная формула для пересчета значений концептов нечетких когнитивных карт представлена на
\ref{img:concepts_recalc}.

$ A_i(t) $ - значение концепта $A_i$ на шаге $t$.

$ p(x) $ - функция активации \ref{img:sigmiog_actiovation}. Параметр $m$ определяет, на сколько сигмоида будет похожа на пороговую функицю.

\def\figurename{Формула}
\begin{figure}[t]
	\centering
	$ A_j(t+1) = p( A_j(t) + \sum_{i = 1, i \neq j}^{n} w_{ij} A_i(t) ) $,
	\caption{Стандартная формула пересчета значений концептов}
	\label{img:concepts_recalc}
\end{figure}
\noindent

\begin{figure}[t]
	\centering
	$ p(x) = \frac {1} {1+ e^{-mx} } $,
	\caption{Сигмоидальная функция активации}
	\label{img:sigmiog_actiovation}
\end{figure}
\def\figurename{Рис.}

В зависимости от задачи и данных, с которыми работает эксперт могут использоваться и другие
функции активации.

После того, как эксперт построил карту, он может приступить к моделированию поведения
системы и изучением причинно-следственной связи. Таким образом, эксперт может посмотреть,
как изменение одного концепта может повлиять на поведение системы в целом.

Если значения концептов карты расходятся, эксперту нужно или попробовать изменить функцию
активации или изменить значения весов концептов. Возможно, карта несбалансированна из-за
того, что в ней отсутствует еще один компонент, который вносит значительный вклад в поведение системы.

Пересчет значений концептов проходит итеративно. Имея исторические данные эксперт может
подобрать значения весов таким образом, чтобы смоделированное поведение системы как можно меньше отличалось
от экспериментальных данных. В случае классических когнитивных карт эксперту нужно это делать вручную.

После того, как эксперт оптимизировал значения весов, можно приступить к изучению причинно-следственных
связей.

\section{Интеграция когнитивных карт и нейросетей для предсказания временных рядов}

Нейро-нечеткая система - это система, которая включает в себя методы нейронных сетей и методы нечеткой логики.

Поведение объекта в сложных системах прогнозировать непросто.
Часто необходимо знать не только результат прогноза,
но и причинно-следственные связи, которыми был обусловлен данный прогноз
\cite{osoba2019dags} \cite{efficient_fcms}.
Для выявления таких причинно-следственных связей используются нечеткие когнитивные карты.
Они позволяют качественно оценить влияние разных компонент системы на другие компоненты.
Однако, оригинальный алгоритм для пересчета значений концептов
не может описать сложные зависимости между отдельными компонентами.
Поэтому для того, чтобы увеличить мощность множества зависимостей, которые
может описать модель системы, можно использовать нейросетевые методы.
В таком случае когнитивная карта все еще хранит данные о причинно-следственных связях.

В нейросетевых подходах установить причинно-следственные связи сложнее.
Другие системы, например, деревья решений, наоборот, очень легко интерпретируются, легко обучаются,
но имеют более слабую способность к обобщению.

Идея нечетких когнитивных карт, предложенных Коско \cite{kosko1986fuzzy} имеет следующие преимущества:

\begin{itemize}
	\item Для проведения вычислений требуются небольшие вычислительные мощности.
	\item Простота в использовании.
	\item Можно легко добавлять и удалять концепты.
	\item Можно объединять готовые модели.
\end{itemize}

Однако есть и недостатки:

\begin{itemize}
	\item Веса линейные, нельзя описать сложную зависимость между концептами.
	\item Значение концепта зависит только от значений связанных концептов карты только на предыдущей итерации.
	Невозможно определить связанные во времени концепты больше, чем на одну итерацию.
	\item Веса карты должны быть оценены экспертно.
\end{itemize}

Эти недостатки можно считать существенными.
С этими недостатками можно бороться, если использовать модификации нечетких когнитивных карт,
например, TTR NFCM (Thee Term Relation Neural Fuzzy Cognotive Map) \cite{threeTermNfcm}.

В отличие от классических нечетких карт TTR NFCM позволяет
определять нелинейные функции для весов и при перерасчете значений концептов может учитывать то, как
этот концепт менялся во времени. Возможность использовать нелинейные веса достигается с помощью многослойных прецептронов.
А влияние предыдущих значений концептов определяется размером временного окна, за период которого проводится перерасчет
значений концептов.

\section{LSTM NFCM -~ Long Short-Serm Memory Neural Fuzzy Cognotive Map}

Можно усовершенствовать модель TTR LSTM, рассмотренную в предыдущем разделе,
если вместо сетей прямого распространения использовать рекуррентные сети,
например, LSTM \cite{LSTM_paper}. Такая сеть позволит более естественно
сохранять информацию об истории концептов в своем скрытом состоянии,
а для того, чтобы учитывать значения концептов на предыдущих итерациях
в сетях прямого распространения, каждый предыдущий шаг должен быть
описан как отдельная "фича", как отдельный параметр модели.

Сравнение LSTM NFCM с полносвязными сетями:
У LSTM NFCM меньше параметров по сравнению с сетью прямого распространения,
которая бы учитывала больше количество предыдущих значений во временном ряде.
LSTM NFCM дольше обучается, но имеет значительно лучшую способность к предсказанию
на длинных временных рядах.
Модель будет дольше обучаться, потому что нельзя распараллелить
процесс обучения LSTM сетей, так как в сети учитывается, что внутренее состояние меняется последовательно.
LSTM NFCM имеет лучшую интерпретируемость, так как содержит
экспертную информацию о взаимосвязи концептов.
Но для построения LSTM NFCM требуется эксперт, а как следствие,
ручная работа.

Сравнение LSTM NFCM с TTR NFCM:
LSTM NFCM дольше обучается, но на сложных данных
может иметь более точные прогнозы.

Сравнение LSTM NFCM с LSTM:
LSTM сеть, которая бы соответствовала LSTM NFCM, будет иметь
больше параметров в случае, если граф LSTM NFCM не слишком
много связей. LSTM NFCM лучше интерпретируема.
Скорость обучения, при условии оптимизаций в LSTM NFCM, с
помощью которых обучение LSTM моделей в каждой вершине бы проходило
параллельно, будет примерно одинаковой.
Предсказательная способность должна быть лучше у LSTM NFCM.
Потому что такая модель более проста и структурирована.
LSTM модель может оказаться излишне усложненной, так как в ней будет
большое количество параметров.
Но для построения LSTM NFCM требуется эксперт, а как следствие,
ручная работа.
Для построения LSTM NFCM требуется эксперт.

Кроме того, так как карта представляет из себя ансамбль
более маленьких моделей, в случае ошибки в исходных данных
в одной части модели, можно переобучать не всю карту целиком,
а только ту часть в которой была ошибка. Так как процесс обучения
может занимать долгое время, эта оптимизация может существенно ускорить процесс.
Такой же прием можно применить и для случая, когда надо дообучить карту на
новом наборе данных: можно дообучать карту частями.

\section{Построение LSTM NFCM}

Для того, чтобы создать модель, нужно определить параметры системы, концепты.
Каждый концепт будет соответствовать вершине графа карты.
После того, как концепты определены, нужно описать взаимодействие между концептами.
Одним из вариантов может быть полносвязный граф, когда каждый концепт имеет
влияние на каждый другой концепт. Теоретически, при увеличении количества
связей в модели, количество возможных зависимостей, которые она может описать
увеличивается. Однако, усложняется и сама модель так, что ее становится сложно обучить.
Слишком сложные модели легко переобучаются на тестовых данных.
Задача эксперта как раз заключается в том, что он должен
описать только необходимые и достаточные взаимосвязи.

Так же, как и большое количество взаимосвязей,
недостаточное количество связей или неверные связи, могут ухудшить
качество модели. Модель может оказаться недостаточно мощной, чтобы описать
исследуемый процесс. Поэтому важно найти именно существенные связи.

После того, как карта построена, необходимо "заморозить карту".
Это означает, что новые связи в карте больше появляться не будут.
Это необходимо для того, чтобы рассчитать параметры моделей, которые
лежат в каждой вершине графа карты: размерность данных на входе,
размерность внутреннего состояния, размерность данных на выходе модели.
Для того, чтобы добавить новый концепт после заморозки карты,
потребуется переобучить карту. Как описано в предыдущем абзаце,
нет необходимости переобучать всю карту целиком. Нужно переобучить только
концепт, к которому добавилась новая связь.

После "заморозки", должны быть инициализированы модели в каждой вершине
карты. Эксперт имеет возможность задать создать любую модель заданной размерности
для каждого концепта отдельно. Выбор модели должен быть основан
на характере данных. Можно использовать как авторегресионные модели,
так и нелинейные, в том числе и нейросетевые. Также можно использовать различные комбинации
этих подходов. Например, "boosting multi-step autoregressive" \ref{taieb2014boosting}.
В данной работе будет использоваться LSTM.

\section{Предобработка данных}

Существуют методы, с помощью которых можно избавиться от сезонности
в данных. Но тут, кажется, что нам это не нужно, потому что есть LSTM'ка

\section{Алгоритм обучения LSTM NFCM}

% todo нужен рисунок
Каждый концепт имеет исторические данные, которые используются
для обучения модели концепта.

Процесс обучения можно разбить на несколько шагов:

\begin{itemize}
	\item Подготовка данных.
	\item Тренировка сети.
	\item Валидация обученной сети.
\end{itemize}

Подготовка данных. На этом этапе происходит разбиение
исторических данных на части для обучения и для валидации.
Это необходимо, чтобы не допустить переобучения сети:
когда на выборке для обучения показатели качества сети
отличные, но на валидационной выборке плохие.
В подготовку данных также нужно включить преобразование данных
в последовательности необходимой размерности. На вход
LSTM сеть принимает матрицу размерности $ seq_len \times batch \times input_size $.
$ seq_len $ -~ длинна последовательности, непрерывный кусок данных.
$ batch $ -~ размер пакета на каждой итерации, для которого будет вычисляться градиент.
$ input_size $ -~ количество связей, которые входят в обучаемый концепт.

Тренировка сети. На данном шаге происходит оптимизиция весов
сети каждого концепта. В качестве оптимизатора
можно взять RMSSE. % todo на самом деле, я этого не сделал, там сейчас просто MSE
В секции "Выбор метрик для оценки качества работы алгоритмов"
приводится обоснование данного выбора.
В качестве оптимизатора будет использован ADAM \ref{adam2014}.
% todo обоснования нет. Можно потестить, мб есть чтополучше

\section{Оценка сложности алгоритма обучения LSTM NFCM}

% возможные оптимизации
% можно параллельно обучать каждую маленькую модель
% можно уменьшать скрытый слой отдельно для каждой модели

\section{Алгоритм вычисления LSTM NFCM}

% todo нужен рисунок



\section{Возможные проблемы алгоритма}

Для обучения  нейросети требуется, чтобы
данные для обучения были репрезентативными. То есть
описывали все возможные значения, которые может принимать система.
Во временных рядах, которые представляют

Можно переобучать модель после того, как появляются новые данные.

Если данных очень много (больше тысячи), модель будет потреблять много памяти.
Но данный метод не относится к методам, в которых нужно просто
пользоваться моделью, как молотилкой. А нацелен на то, чтобы наоборот
получить больше понимания о процессе.

При достаточно большом количестве временных рядов,
становится сложно экспертно определить взаимодействие между концептами.
Для задач с большим количеством рядов для исследования, без
модификаций, данный метод не будет эффективен. Так как потребует
большое количество вычислительных ресурсов.
Для таких задач можно использовать, например, градиентный бустинг \ref{friedman2002stochastic}.

\section{Возможные дальнейшие направления для исследований}

Предложенная модель довольно долго обучается и требует много ресурсов
для вычисления. Если найти способ более быстрого вычисления,
теоретически, даже при большом наборе временных рядов, которые нужно
исследовать, можно было бы перебрать различные комбинации взаимосвязей концептов.


\section{Выбор метрик для оценки качества работы алгоритмов}

В качестве критерия качества результата работы системы для предсказаний
для одного временного ряда, можно взять среднеквадратическую
масштабированную ошибку (RMSSE) \ref{hyndman2006another}.
Она вычисляется она по формуле \ref{img:rmsse}

% todo кажется, я это и не использовал
\def\figurename{Формула}
\begin{figure}
	\centering
	$ RMSSE = \sqrt{ \frac{ \frac{1}{h} \sum_{t=n+1}^{n+h}(Y_t - \hat{Y_t})^2  }{ \frac{1}{n-1} \sum_{t=2}^{n} (Y_t - Y_{t-1})^2 } } $,

	\caption{Root Mean Squared Scaled Error.
	(
		$ h $ ~- горизонт предсказаний,
		$ n $ ~- количество измерений обучающей выборки,
		$ Y_t $ ~- истинное значение временного ряда в момент времени $ t $,
		$ \hat{Y_t} $ ~- предсказанное значение временного ряда в момент времени $ t $
	)}
	\label{img:rmsse}
\end{figure}
\def\figurename{Рис.}

Данная метрика обладает рядом преимуществ:

\begin{itemize}
	\item Ошибка не зависит от масштаба и может быть эффективно использована для предсказаний временных рядов разных масштабов.
	\item Функция может быть вычислена безопасно. Деление на ноль может произойти только если временной ряд состоял из одного повторяющегося числа.
	\item Одинаково штрафуются и положительные, и отрицательные отклонения, метрика симметрична.
\end{itemize}

Для того, чтобы оценить получить ошибку по предсказанию для всех временных рядов,
можно использовать взвешенную среднеквадратическую масштабированную ошибку.
Она вычисляется по формуле \ref{wrmsse}

\def\figurename{Формула}
\begin{figure}
	\centering
	$ WRMSSE = \sum_{i=1}^{k} w_i * RMSSE_i $,
	\caption{
		Weighted Root Mean Squared Scaled Error.
		(
			$ k $ ~- количество временных рядов,
			$ w_i $ ~- вес ошибки временного ряда $ i $
		)
	}
	\label{img:wrmsse}
\end{figure}
\def\figurename{Рис.}

\section{Выводы}

В данной главе была рассмотрена модель когнитивных карт.
Была разработана модель когнитивных карт
с использованием нейросетей (рекуррентных и прямого распространения).
Были выбраны методы оценки качества работы разрабатываемой системы.