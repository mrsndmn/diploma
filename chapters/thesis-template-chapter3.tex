\chapter{Результаты проектирования}

\begin{annotation}
	В данной главе разрабатываются функциональные требования к разрабатываемой системе.
	Проектируется интерфейс модуля. Проектируется структура когнитивной карты.
	Проводится выбор инструментальных средств разработки.
\end{annotation}


\section{Разработка функциональных требований к системе}

Так как разрабатываемый модуль предназначен для решения задачи, которая
требует интенсивные вычисления, система должна быть реализована
с возможностью оптимизации данных вычислений. Распараллеливать вычисления
можно с помощью видеокарт. Это можно сделать с использованием фреймворка $ pytorch $.

Для проверки качества кода и его работоспособности, должны быть написаны тесты.
Автотесты помогают быстрее находить ошибки и регрессии в функциональности программы.

Эксперт должен иметь возможность задать произвольные концепты, описать
взаимосвязь между концептами явно или неявно, с помощью обученной карты.
Для того, чтобы обучить карту, эксперт должен иметь возможность загрузить
в нее исторические данные.

Эксперт должен иметь возможность построить графики зависимостей концептов
как по историческим данным, так и по предсказанным данным.

Таким образом, функциональные требования:
\begin{itemize}
	\item Возможность распараллеливания вычислений, с использованием фреймворка $pytorch$.
	\item Система непрерывной интеграции и автоматизированное тестирование.
	\item Поддержка заданных экспертом зависимостей между концептами.
	\item Поддержка зависимостей между концептами, вычисляемых с помощью LSTM.
	\item Возможность визуально представить данные о карте: об истории обучения, качестве модели.
	\item Модуль должен быть расширяемым. Нужна возможность определить пользовательскую функцию для постобработки данных, сгенерированных картой.
	\item Возможность динамических предсказаний. Динамические предсказания --- это
	предсказание, построенное на данных, которые были сгенерированы моделью на предыдущих шагах цикла.
	\item Возможность задать экзогенные параметры через карту.
\end{itemize}

% todo как идея, можно прикрутить мониторинг того, как обучается модель

\section{Архитектура системы непрерывной интеграции}

При отправке новых изменений в исходных текстах модуля,
удаленный репозиторий запускает обработчик тестов.
В этом обработчике запускаются команды, которые
проверяют работоспособность и качество кода в проекте.
В случае ошибок, pull-request блокируется, новые изменения не могут попасть
в ветку $ master $. На почту разработчика приходит уведомление, что
тесты не прошли.

Когда тестов становится слишком много, для того, чтобы было
проще ориентироваться, где именно произошла ошибка,
можно пользоваться отдельными приложениями для построения
отчетов о тестировании. К таким отчетам можно прикреплять
дополнительную отладочную информацию, какую пожелает разработчик тестов.
Однако на данном этапе тестов не будет очень много и это пока что не целесообразно.

\section{Проектирование интерфейса модуля}

Работа с модулем должна состоять из следующих шагов:
\begin{itemize}
	\item Эксперт описывает карту и загружает в нее исходные данные.
	\item Карта обучается.
	\item Выполняется предсказание.
	\item Карта модифицируется, дополняется.
	\item И т д
\end{itemize}

\textbf{Описание концептов.}
При описании карты разработчик может задать
любое количество концептов и связать их любым образом.
При создании концепта требуется указать модель,
по которой будет предсказываться этот концепт, название
концепта и связи концепта с другими концептами.

\textbf{Концепты для автоматического обучения.}
Для автоматического обучения можно использовать LSTM
модель. А также SARIMAX модель для полуавтоматического
обучения. Разработчику будет необходимо задать гиперпараметры
для SARIMAX модели.

\textbf{Концепты для пост-обработки предсказаний.}
Удобно на том же графе, что и строится карта,
иметь возможность задать, как должны быть преобразованы
предсказанные данные. Должна быть возможность
комбинировать разные типы узлов. Также требуется возможность
задавать

\textbf{Обучение.}
Во время обучения, должны быть определены приоритеты
вычислений тех или иных концептов.
Теоретически, этот этап может быть распараллелен.
Все модели, поддерживаемые картой должны
иметь общий интерфейс для обучения и вычисления,
чтобы не нарушать инкапсуляцию. Логика предсказаний
и логика обучения должна быть скрыта внутри модели.

\textbf{Вычисление карты.}
Для вычисления карты от поддерживаемых моделей также требуется
чтобы логика по вычислению моделей не вышла за границы модели.
В зависимости от типа модели должна быть возможность получить
график функции потерь для модели, чтобы оценить качество предсказаний.

\textbf{Модификация карты.}
При добавлении новых концептов, нужно заново обучить
связанные концепты. При удалении концептов, потребуется
переобучение зависимых от удаленного концепта вершин.

\textbf{Моделирование с помощью когнитивной карты.}
Суть моделирования заключается не только в том, чтобы подобрать
оптимальные параметры для выборке для обучения и провалидировать обученную модель.
Эксперт может выдвинуть гипотезу, подстроить параметры модели
и исследовать, как будет вести себя система, анализировать
остатки, которые дает модель. Добавлять или удалять концепты с
целью найти объяснение тем или иным процессам. Так же эксперт
может добавлять в модель экзогенные параметры, которые могут
спрогнозировать поведение системы. Экзогенные параметры
должны быть определены экспертом не только на выборке для обучения,
но и на тестовой выборке. Предполагается, что эти параметры можно вычислить заранее.
В итоге эксперт должен получить граф, который описывает
исследуемый процесс. Этот граф можно интерпретировать
в соответствии с названиями каждой вершины, концепта.
Каждый концепт имеет свою историю значений. И может зависеть или
влиять на другие концепты. Таким образом, он отражает знания
эксперта об исследуемой системе. И с помощью функций, преобразований,
которые эксперт задал на этом графе, может быть получено предсказание
определенных значений концептов.

\textbf{Повторное обучение.}
Так же как и для модификации карты. Не обязательно переобучать всю карту целиком.
Если в этом есть необходимость, можно переобучить только часть карты.


\section{Проектирование структуры когнитивной карты для моделирования количества продаж}

Исследуемые данные представляют из себя несколько временных рядов
за 5 лет по количеству продаж в 3 разных магазинах по 3 разным категориям:

\begin{itemize}
	\item Еда
	\item Товары для дома
	\item Товары для хобби
\end{itemize}

Процесс покупки продуктов --- это социально-экономический процесс.
Количество продаж может зависеть от локальных или национальных праздников.
Продажи по конкретным товарам могут возрастать, если на эти товары есть скидки или акции.
Но так же стоит помнит, что в случае, если товар не завезли,
продажи такого товара будут нулевыми. Но это не значит, что этот товар никому не нужен.

В данной работе будет построена упрощенная модель карты для предсказания количества продаж.
Но влияние экзогенных параметров будет исследовано на других моделях.

Общее количества продаж складывается из сумм продаж
по в каждом магазине:

\begin{equation}\label{eq:sales_total_simple_model}
	STORE\_SALES\_{i} = \sum_{j=1}^{M} CATEGORY\_SALES_{i,j}
\end{equation}

\noindent A продажи в каждом магазине складываются из продаж
товаров каждой категории:

\begin{equation}\label{eq:store_sales_simple_model}
	STORE\_SALES\_{i} = \sum_{j=1}^{M} CATEGORY\_SALES_{i,j}
\end{equation}

Тогда когнитивная карта будет содержать следующие вершины:

\begin{itemize}
	\item $ total\_sales $ --- общее количество продаж
	\item $ store\_id\_TX\_1 $ --- количество продаж в первом магазине
	\item $ store\_id\_TX\_1\_cat\_id\_FOODS $ --- количество продаж в первом магазине в категории "еда"
	\item $ store\_id\_TX\_1\_cat\_id\_HOBBIES $ --- количество продаж в первом магазине в категории "товары для хобби"
	\item $ store\_id\_TX\_1\_cat\_id\_HOUSEHOLD $ --- количество продаж в первом магазине в категории "товары для дома"
	\item $ store\_id\_TX\_2 $ --- количество продаж во втором магазине
	\item $ store\_id\_TX\_2\_cat\_id\_FOODS $ --- количество продаж во втором магазине в категории "еда"
	\item $ store\_id\_TX\_2\_cat\_id\_HOBBIES $ --- количество продаж во втором магазине в категории "товары для хобби"
	\item $ store\_id\_TX\_2\_cat\_id\_HOUSEHOLD $ --- количество продаж во втором магазине в категории "товары для дома"
	\item $ store\_id\_TX\_3 $ --- количество продаж в третьем магазине
	\item $ store\_id\_TX\_3\_cat\_id\_FOODS $     --- количество продаж в третьем магазине в категории "еда"
	\item $ store\_id\_TX\_3\_cat\_id\_HOBBIES $   --- количество продаж в третьем магазине в категории "товары для хобби"
	\item $ store\_id\_TX\_3\_cat\_id\_HOUSEHOLD $ --- количество продаж в третьем магазине в категории "товары для дома"
\end{itemize}

Для моделирования продаж по каждой категории в конкретном магазине
будет использоваться LSTM.
Таким образом имея предсказания продаж для товаров каждой категории в каждом магазине
мы можем явно вычислить количество продаж в магазине целиком и в сумме для трех магазинов.
Для этого необходимо просуммировать результат предсказаний каждой категории
в каждом магазине --- $ CATEGORY\_SALES_{i,j} $.
Для этого при построении карты для значений концептов

\begin{itemize}
	\item $ total\_sales $
	\item $ store\_id\_TX\_1 $
	\item $ store\_id\_TX\_2 $
	\item $ store\_id\_TX\_3 $
\end{itemize}

\noindent будет использоваться простая модель для суммирования.
Особенность ее заключается в том, что модель LSTM в вершинах FCM-LSTM работает
с предыдущими историческими значениями концептов. А модель по суммированию должна работать
с уже предсказанными результатами модели LSTM.

Граф спроектированной карты представлен на рисунке \ref{img:fcm_lstm_map}.

\def\figurename{Рис}
\begin{figure}[t]
	\centering
	\includegraphics[width=0.5\columnwidth]{./img/fcm_lstm_map.png}
	\caption{Граф когнитивной карты для моделирования общего количества продаж с разбивкой по магазинам и категории товаров}
	\label{img:fcm_lstm_map}
\end{figure}

\section{Выбор инструментальных средств}

В качестве языка программирования для проведения экспериментов и анализа данных
будет использоваться python. Это язык с динамической типизацией, но зато с
большим количеством хорошо протестированных и отлаженных фреймворков и библиотек для работы
с данными ($numpy$ \cite{oliphant2006guide}, $pandas$ \cite{reback2020pandas}), статистическим анализом ($statmodels$ \cite{seabold2010statsmodels})
и фреймфорками для построения нейросетей ($pytorch$ \cite{NEURIPS2019_9015}, $tensorflow$ \cite{tensorflow2015-whitepaper} ).

Для распараллеливания работы с данными и использовании аппаратных ускорений для умножений матриц
для реализации модуля подсистемы обработки данных и подсистемы для вычисления нечеткой карты
будет использоваться $pytorch$. Это фреймворк для работы с данными и созданию нейросетей.

Конкурентом $pytorch$ является $tensorflow$, но за счет того, что в $pytorch$ не статический
граф вычислений, а динамический, $pytorch$ предоставляет больше свободы, но и больше мест,
где можно ошибиться.

Недостатком python можно считать динамическую типизацию. Динамическая типизация не позволяет
найти многие ошибки на стадии компиляции. Многие ошибки можно обнаружить только во время
работы программы. Для того, чтобы бороться с этим недостатком, вместе с кодом нужно писать
автоматические тесты --- они позволяют быстро проверить работоспособность программы.

Для написания автоматических тестов был выбран фреймворк $ pytest $ \cite{pytestx.y}. В этом фреймворке
вводится понятие фикстур. Это помогает разделить тело теста (логику тести) и
подготовку данных для тестирования. Фикстуры позволяют сохранять тело
теста более чистым. Это позволяет быстро определить, в чем именно заключается ошибка.
Кроме того, благодаря возможности параметризации фикстур и теста, можно
запустить один и тот же тест с разными наборами данных.

Для работы с графами был выбран фреймворк $ networkx $ \cite{hagberg-2008-exploring}. Данный фреймворк
обладает удобным интерфейсом для построения и работы с графами и
позволяет визуально представить построенный граф.

Для разработки, отладки разрабатываемых модулей а так же для
анализа данных использовалась интерактивная среда вычислений Jupyter Notebook \cite{Kluyver:2016aa}.


\section{Выводы}

В данном разделе были рассмотрена архитектура системы
непрерывной интеграции, выставлены функциональные требования
и спроектирован интерфейс модуля и спроектирована архитектура
когнитивной карты для прогнозирования количества продаж.